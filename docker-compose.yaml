

services:
  mlflow-postgres-db:
    container_name: mlflow-backend-store
    image: postgres:14
    env_file:
      - .envs/.postgres
    volumes:
      - postgres-mlflow-data:/var/lib/postgresql/data
  
  mlflow-tracking-server:
    image: local-mlflow-tracking-server
    container_name: local-mlflow-tracking-server
    build:
      context: .
      dockerfile: ./docker/dockerfile_mlflow
      args:
        USER_NAME: ${USER_NAME}
        USER_ID: ${USER_ID}
        #MLFLOW_ARTIFACT_STORE: ${MLFLOW_ARTIFACT_STORE}
    ports:
      - 8080:8080
    env_file:
      - .envs/.postgres
      - .envs/.mlflow
    depends_on:
      - mlflow-postgres-db
    volumes:
      - ~/.config/gcloud/:/home/${USER_NAME}/.config/gcloud
    #  - mlflow-artifact-store:${MLFLOW_ARTIFACT_STORE}

  fastapi-server:
    image: fastapi-server
    container_name: fastapi-server
    build:
      context: .
      dockerfile: ./docker/dockerfile_fastapi
      args:
        USER_NAME: ${USER_NAME}
        USER_ID: ${USER_ID}
    ports:
      - 8000:8000
  
  
    ipc: host
    init: true
  

volumes:
  postgres-mlflow-data:
  #mlflow-artifact-store:
    

