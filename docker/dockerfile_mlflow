FROM python:3.11-slim

ARG USER_ID
ARG USER_NAME
ARG MLFLOW_ARTIFACT_STORE

ENV HOME=/home/${USER_NAME}
ENV PATH=$PATH:${HOME}/.local/bin

RUN apt-get -qq update \
    && apt-get -qq -y install curl

RUN useradd --user-group --no-log-init --create-home --home-dir ${HOME} --uid ${USER_ID} ${USER_NAME} 

COPY ./docker/scripts/* /
RUN chown -R ${USER_NAME} /*.sh && chmod +x /*.sh

RUN mkdir -p ${HOME}/app ${MLFLOW_ARTIFACT_STORE} 
RUN chown -R ${USER_NAME} ${HOME}/app ${MLFLOW_ARTIFACT_STORE} 


RUN curl -sSL https://install.python-poetry.org | python3 -

USER ${USER_NAME}
 
WORKDIR ${HOME}/app
COPY . .

RUN poetry install


CMD ["/startup-script.sh"]


